# ============================================
# Backend Development
# ============================================
FROM continuumio/miniconda3:latest AS backend-dev

ENV LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH=/opt/conda/envs/music_app_docker_env/bin:$PATH

WORKDIR /project_folder

# Install system dependencies
RUN apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y \
        build-essential \
        libpq-dev \
        netcat-traditional \
        && apt-get clean && \
        rm -rf /var/lib/apt/lists/*

# Copy environment file
COPY environment.yml /project_folder/

# Create conda environment
RUN conda env create -f environment.yml -n music_app_docker_env && \
    conda clean -afy

# Initialize conda
RUN echo "source activate music_app_docker_env" >> ~/.bashrc

# Create non-root user
RUN adduser --disabled-password --gecos "" nonroot

# Copy project files
COPY . /project_folder/

# Change ownership
RUN chown -R nonroot:nonroot /project_folder

USER nonroot

EXPOSE 8000

CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]